# Анализ кодовой базы

## Общая структура проекта

Проект представляет собой Telegram-бота для работы с криптовалютными кошельками, в основном ориентированный на сеть Stellar и токены MTL/EURMTL. Бот написан на Python с использованием фреймворка Aiogram 3.x.

## Основные компоненты

### Точка входа
- `start.py` - основной файл запуска бота, содержит инициализацию бота, диспетчера, планировщика задач и регистрацию роутеров

### Конфигурация
- `other/config_reader.py` - чтение конфигурации из .env файла с помощью Pydantic

### База данных
- `db/db_pool.py` - управление пулом соединений с базой данных (SQLAlchemy)
- `db/models.py` - модели данных (упоминается, но не представлена полностью)
- `db/requests.py` - функции для работы с базой данных (упоминается, но не представлена полностью)

### Middleware
- `middleware/db.py` - middleware для работы с сессиями базы данных
- `middleware/log.py` - логирование действий пользователя
- `middleware/old_buttons.py` - обработка устаревших кнопок
- `middleware/retry.py` - повторные попытки запросов (упоминается, но не представлена полностью)
- `middleware/throttling.py` - ограничение частоты запросов

### Роутеры
Множество роутеров для различных функций бота:
- `routers/common_start.py` - обработка стартовых команд
- `routers/common_end.py` - обработка завершающих команд
- `routers/cheque.py` - работа с чеками
- `routers/bsn/__init__.py` - работа с BSN (Business Stellar Network)
- `routers/receive.py` - получение средств
- `routers/fest.py` - функционал для фестивалей
- и другие (send, sign, swap, inout, mtlap, wallet_setting, veche и т.д.)

### Утилиты
- `other/aiogram_tools.py` - вспомогательные функции для работы с Aiogram
- `other/global_data.py` - глобальные данные и состояния
- `other/grist_tools.py` - интеграция с Grist (табличный сервис)
- `other/lang_tools.py` - инструменты для локализации (упоминается, но не представлена полностью)
- `other/stellar_tools.py` - работа с Stellar API
- `other/time_handlers.py` - обработчики, связанные со временем и таймаутами
- `other/tron_tools.py` - работа с TRON API
- `other/web_tools.py` - HTTP-клиент для внешних API

### Локализация
- `langs/ru.json` - русская локализация интерфейса
- `langs/en.json` - английская локализация интерфейса

### Скрипты деплоя
- `deploy/mmwb_bot.update.sh` - обновление сервиса
- `deploy/mmwb_bot.restart.sh` - перезапуск сервиса
- `deploy/structure.py` - скрипт для анализа структуры проекта

## Основные функции бота

1. **Управление кошельками Stellar**:
   - Создание и импорт кошельков
   - Просмотр баланса
   - Отправка и получение средств
   - Подписание транзакций

2. **Работа с токенами**:
   - Управление линиями доверия (trust lines)
   - Обмен токенов (swap)
   - Торговля на децентрализованной бирже

3. **Дополнительные функции**:
   - Создание и получение чеков
   - Ввод/вывод средств в другие сети (TRON)
   - Интеграция с MTL Фондом и Ассоциацией
   - Делегирование голосов (Veche)
   - Работа с BSN (Business Stellar Network)

- **Поддержка возврата на внешний сайт:** если в URI присутствует параметр `return_url`, после завершения операции пользователю всегда показывается кнопка для возврата на указанный сайт, даже если отсутствует callback. Логика формирования такой клавиатуры централизована в отдельной функции.

## Архитектурные особенности

1. **FSM (Finite State Machine)** - для управления состояниями диалога с пользователем
2. **Middleware** - для обработки запросов, логирования и работы с БД
3. **Роутеры** - для организации обработчиков команд
4. **Асинхронное программирование** - использование asyncio для неблокирующих операций
5. **Локализация** - поддержка нескольких языков (видна русская локализация)
6. **Интеграция с внешними API** - Stellar, TRON, Grist и другие
7. **Read-only кошельки** - для read-only кошельков используется признак `use_pin == 10` в таблице MyMtlWalletBot. Такие кошельки не позволяют выполнять операции, требующие приватного ключа (например, вывод средств). В интерфейсе может отображаться пометка `(r/o)`.

## Безопасность

- Шифрование приватных ключей
- Защита PIN-кодом или паролем
- Проверка старых кнопок для предотвращения случайных действий
- Ограничение частоты запросов (throttling)
- Для read-only кошельков используется признак `use_pin == 10` в таблице MyMtlWalletBot. Такие кошельки не позволяют выполнять операции, требующие приватного ключа (например, вывод средств). В интерфейсе может отображаться пометка `(r/o)`.

## Мониторинг и логирование

- Интеграция с Sentry для отслеживания ошибок
- Логирование действий пользователя
- Обработка таймаутов для длительных операций

## Локализация

- Для локализации используется простой механизм key-value, где ключи хранятся в коде, а значения - в JSON-файлах (`langs/ru.json`, `langs/en.json` и т.д.).
- Функция `my_gettext` в `other/lang_tools.py` используется для получения перевода текста на основе языка пользователя.
- Язык пользователя хранится в базе данных и в оперативной памяти (`global_data.user_lang_dic`).
- При отсутствии перевода на языке пользователя используется английский язык.
- Для форматирования сообщений бота используется HTML-разметка, а не Markdown. Поддерживаются теги `<b>` (жирный), `<i>` (курсив), `<code>` (моноширинный шрифт), `<pre>` (блок кода), `<s>` (зачеркнутый), `<u>` (подчеркнутый) и `<a>` (ссылки).

## Очистка состояния (State Clearing)

- Для управления состоянием бота используется FSM (Finite State Machine) из библиотеки Aiogram (`aiogram.fsm`).
- Очистка состояния производится с помощью функции `clear_state` в `other/aiogram_tools.py`.
- Функция `clear_state` не удаляет все данные из состояния, а сохраняет некоторые ключи, такие как `show_more`, `user_name`, `user_id`, `user_lang`, `last_message_id`, `mtlap` и `free_xlm`.